# Intermediate ActiveRecord

---

# Warmup

Assume a Rails app that has owners and horses.

How would you find the following in ActiveRecord?

* Average age of all horses
* Average age of horses belonging to an owner with an id of 1
* Total winnings of all horses (assume a `winnings` column on horses)
* Total winnings of all horses belonging to an owner with an id of 4

---

# ActiveRecord is About Objects

```
> rails c
> Candidate.all
> Candidate.find(1)
> Parties.find(1)
> Candidate.find(1).parties
> Candidate.joins(:party)
```

But it helps to think about the underlying tables that are being created!

---

# ActiveRecord Attributes

* Methods generated by AR based on table columns
    * candidates has an `id`, `name`, and `party_id`
    * Candidate.first responds to `#id`, `#name`, and `#party_id`
* What determines what kind of object AR returns?

---

# Working with IDs

* Lots of code snippets in the next section
* Often returning IDs instead of objects
* Learning tool that we're using temporarily
* Showing in context of models
* Can practice in the console

---

# ActiveRecord Arguments

In most cases:

* Can use symbols/hashes
* Can use strings to pass raw SQL
* Don't be afraid of raw SQL - it's your friend

---

# With a Partner

* Review Election Schema

---

# Select

* Tells the query what columns to select.

---

# Select Example

```ruby
# On Candidate
def self.no_dates
  select(:id, :name, :party_id)
end
```

---

# Joins

* Class method
* Pull information from multiple tables
* Results in rows with duplicate information
* Limited to records where related record exists

---

# Joins Example

```ruby
# On the Candidate model
def self.candidates_with_primary_results
  joins(:primary_results)
end
```

* Symbol argument uses the `has_many` that exists in the Candidate model.

---

# Group

* Used to group by a characteristic
* Needs an aggregate function
* What's an aggregate function?
    * AVG
    * COUNT
    * MIN
    * MAX
    * SUM

---

# Group Example

```ruby
# On County model
# Returns a hash with IDs for keys
def self.count_by_state_id
  group(:state_id).count
end

# OR #

# On State model
# Returns a hash with State names for keys
def self.count_of_counties
  joins(:counties).group(:name).count
end
```

---

# Group With Calculation

* Can use calculations as aggregate funcitons

```ruby
# On State
# Returns a hash with State names for keys
def self.votes_by_state
  joins(:primary_results).group(:name).sum(:votes)
end
```

---

# Group With Order

```ruby
# On State
# Returns a hash with State names for keys
def self.ordered_votes_by_state
  joins(:primary_results)
    .group(:name)
    .order("sum_votes DESC")
    .sum(:votes)
end
```

---

# Select (So what?)

```ruby
# On State
# Returns a collection of *objects*
def self.with_votes
  joins(:primary_results)
    .select('states.id,
             states.name,
             states.abbreviation,
             SUM(primary_results.votes) AS sum_of_votes')
    .group('states.id')
end
```

---

# Exercise

Can you create an array of democratic candidates ordered by the number of results they received that also responds to `vote_totals`?

```
# rails c
> candidates = YOUR QUERY HERE
> candidates.first.name
> "Hillary Clinton"
> candidates.first.total_votes
# => 15692452
```

* How would you make this into a method on your Candidate model?

